name: Notify Discord on release

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send release to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO_NAME: ${{ github.event.repository.name }}
          BRANCH: ${{ github.event.release.target_commitish }}
          TAG: ${{ github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          RELEASE_BODY: ${{ github.event.release.body || '' }}
          RELEASE_NAME: ${{ github.event.release.name || github.event.release.tag_name }}
          AUTHOR_LOGIN: ${{ github.event.release.author.login || github.actor }}
          AUTHOR_AVATAR: ${{ github.event.release.author.avatar_url || '' }}
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          FIRST_LINE=$(echo "$RELEASE_BODY" | head -n 1)
          if [ -z "$FIRST_LINE" ]; then FIRST_LINE="$RELEASE_NAME"; fi
          if [ -z "$FIRST_LINE" ]; then FIRST_LINE="Release"; fi

          BODY=$(jq -n \
            --arg repo "$REPO_NAME" \
            --arg branch "$BRANCH" \
            --arg sha "$SHORT_SHA" \
            --arg tag "$TAG" \
            --arg line "$FIRST_LINE" \
            --arg author "$AUTHOR_LOGIN" \
            --arg url "$RELEASE_URL" \
            --arg avatar "$AUTHOR_AVATAR" \
            '{
              "embeds": [{
                "author": (if $avatar != "" then { "name": $author, "icon_url": $avatar } else { "name": $author } end),
                "title": ("[" + $repo + ":" + $branch + "] 1 new release"),
                "url": $url,
                "description": ($sha + " " + $tag + " - " + $line + ". - " + $author),
                "color": 5814783
              }]
            }')
          curl -s -X POST -H "Content-Type: application/json" -d "$BODY" "$DISCORD_WEBHOOK_URL"
